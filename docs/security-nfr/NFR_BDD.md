# Приёмочные сценарии (BDD) для нефункциональных требований

## Feature: Производительность и стабильность API

### Scenario: p95 времени ответа API не превышает порог при 50 RPS
**Given** сервис запущен в окружении stage
**And** нагрузочный профиль генерирует 50 RPS на эндпоинты `/habits` и `/checkins`
**When** выполняется 5-минутный тест с инструментом k6
**Then** p95 времени ответа каждого REST эндпоинта ≤ 200 мс

---

### Scenario (Negative): API деградирует при повышении нагрузки свыше 100 RPS
**Given** сервис работает под нагрузкой 100 RPS
**When** нагрузочный тест выполняется в течение 10 минут
**Then** p95 не должен превышать 400 мс,
**And** количество ошибок 5xx ≤ 1% от всех запросов

---

## Feature: Корректность статистики (`completion_rate`)

### Scenario: Расчёт completion_rate точен для полного набора данных
**Given** в системе зарегистрировано 10 привычек и 100 отметок (checkins)
**And** 80 из них помечены как `completed=True`
**When** вызывается эндпоинт `/stats`
**Then** возвращаемый показатель `completion_rate` равен 80.00 (+\- 0.1%)

---

### Scenario (Negative): Расчёт статистики при пустых данных
**Given** база данных не содержит ни одной привычки и отметки
**When** выполняется запрос к `/stats`
**Then** сервис возвращает корректный объект с `completion_rate=0.0`
**And** не возникает ошибок вычисления (NaN, деление на ноль)

---

## Feature: Доступность сервиса

### Scenario: Проверка аптайма `/health` за месяц
**Given** система мониторинга подключена к `/health`
**When** производится ежеминутная проверка доступности в течение календарного месяца
**Then** суммарный аптайм сервиса ≥ 99.5%

---

### Scenario (Negative): Поведение при временной недоступности
**Given** один из внутренних сервисов зависает на 5 секунд
**When** пользователь обращается к `/health`
**Then** сервис должен вернуть код 503
**And** запись об этом событии фиксируется в логах уровня ERROR

---

## Feature: Целостность данных

### Scenario: Нельзя создать checkin без существующей привычки
**Given** пользователь создаёт отметку (`checkin`) с `habit_id=999`
**And** привычка с таким ID отсутствует
**When** выполняется POST `/checkins`
**Then** сервер возвращает ошибку с кодом 404
**And** тело ошибки соответствует формату `{"error": {"code": "not_found", "message": "Habit not found"}}`

---

## Feature: Безопасность паролей

### Scenario: Хэширование пароля через Argon2id
**Given** пользователь регистрируется с новым паролем
**When** пароль сохраняется в базе данных
**Then** значение хранится только в виде Argon2id-хэша

---

### Scenario (Negative): Попытка сохранить пароль в открытом виде
**Given** модуль аутентификации получает пароль как текст
**When** происходит запись в хранилище без хэширования
**Then** тест должен завершиться неуспешно (assertion fail)
**And** отчёт CI помечает задачу как failed
