# ADR-003: Rate Limiting стратегия с многоуровневыми лимитами
Дата: 2025-10-20
Статус: Accepted

## Context
Существующий глобальный rate limit 50 запросов/минуту на IP слишком общий и не учитывает специфику эндпоинтов. Это создает риски: эндпоинты создания данных (`/habits`, `/checkins`) могут быть перегружены, в то время как мониторинговые эндпоинты (`/health`) имеют недостаточную пропускную способность для систем наблюдения.

## Decision
Многоуровневая стратегия лимитов на основе `slowapi`:

**Глобальные лимиты:**
- По умолчанию: 100 запросов/минуту на IP
- Эндпоинты создания: 10 запросов/минуту на IP (`/habits`, `/checkins`)

**Специфичные лимиты:**
- `/health`: 500/минуту (мониторинг)
- Эндпоинты аутентификации (будущие): 5/минуту на IP
- Админские эндпоинты: по API-ключу

## Alternatives
1.  **Единый глобальный лимит (текущее состояние)**
    *   **Плюсы:** Простота реализации и конфигурации, минимальные накладные расходы.
    *   **Минусы:** Не учитывает разную критичность эндпоинтов, может блокировать легитимные запросы к `/health` при атаке на API, неоптимальное использование ресурсов.

2.  **Многоуровневая стратегия (ВЫБРАНО)**
    *   **Плюсы:** Гранулярная защита уязвимых эндпоинтов, оптимальное распределение ресурсов.
    *   **Минусы:** Сложность конфигурации и поддержки.

3.  **Token Bucket с динамическими лимитами**
    *   **Плюсы:** Более гибкое управление пропускной способностью, лучшее соответствие реальным паттернам использования.
    *   **Минусы:** Значительно сложнее в реализации, требует кастомного кода, избыточно для текущих потребностей MVP.

## Consequences
### Security Impact
*   **Положительные:** Значительное снижение риска DDoS/DoS атак, защита эндпоинтов создания данных от злоупотреблений, предотвращение brute-force атак на будущие эндпоинты аутентификации. Лимиты на создание данных защищают от spam-атак.
*   **Отрицательные/Риски:** Ложные срабатывания могут блокировать легитимных пользователей. *Меры смягчения: мониторинг срабатываний лимитов, возможность временного увеличения лимитов для trusted partners.*

### Overall Impact
*   **KPI/SLO:** Увеличивается доступность сервиса - защита от перегрузки, улучшается SLO uptime. Снижается нагрузка на базу данных за счет ограничения операций записи.
*   **Производительность:** Незначительные накладные расходы на проверку лимитов (1-2 мс на запрос)
*   **Разработка:** Необходимость явного указания лимитов для новых эндпоинтов

## Rollout Plan
*   **Definition of Done (DoD):**
    1.  Библиотека `slowapi` интегрирована в проект
    2.  Глобальный лимит установлен и работает
    3.  Специфичные лимиты для ключевых эндпоинтов реализованы
    4.  Тесты проверяют срабатывание лимитов для всех сценариев
    5.  Ошибки rate limiting возвращаются в формате RFC 7807

*   **План внедрения:**
    1.  Базовая интеграция `slowapi` с глобальным лимитом 50/минуту
    2.  Реализация многоуровневой стратегии с разными лимитами
    3.  Написание тестов для проверки срабатывания лимитов
    4.  Мониторинг и настройка лимитов на основе реальной нагрузки

## Links
- NFR-01, NFR-05 (Производительность и лимиты)
- R7, FastAPI из Thread Model
