# ADR-002: Единый формат ошибок по RFC 7807
Дата: 2025-10-20
Статус: Accepted

## Context
Текущий формат ошибок `{"error": {"code": ..., "message": ...}}` нестандартен. RFC 7807 предоставляет общепринятый стандарт для machine-readable ошибок, улучшая клиентский опыт и совместимость.

## Альтернативные решения

### Вариант 1: Сохранение текущего кастомного формата
**Плюсы:**
- Уже реализован и работает
- Компактный размер ответов
- Не требует миграции существующих клиентов

**Минусы:**
- Нестандартный подход, усложняет интеграцию с внешними клиентами
- Ограниченные возможности для расширения
- Нет стандартных полей для трассировки (correlation_id, timestamp)
- Может потребовать доработки при добавлении новых типов ошибок

### Вариант 2: RFC 7807 (ВЫБРАНО)
**Плюсы:**
- Общепринятый стандарт, знакомый разработчикам
- Расширяемая структура с предсказуемыми полями
- Встроенная поддержка трассировки и временных меток
- Лучшая документация и инструменты экосистемы

**Минусы:**
- Больший размер ответов
- Необходимость миграции существующих клиентов
- Дополнительная сложность в реализации

## Decision
Принять RFC 7807 с расширениями для внутренней совместимости:

```json
{
  "type": "https://habittracker.com/errors/validation-error",
  "title": "Validation Failed",
  "status": 400,
  "detail": "Name must be between 1 and 100 characters",
  "instance": "/habits",
  "code": "VALIDATION_ERROR",
  "timestamp": "2025-09-22T10:30:00Z",
  "correlation_id": "req-123456"
}
```

**Параметры:**
- `correlation_id` - для трассировки запросов
- `code` - внутренний код ошибки (обратная совместимость)
- Все ошибки уровня 4xx/5xx используют этот формат

## Consequences
**Плюсы:** Стандартизация, лучшая диагностика
**Минусы:** Миграция существующих клиентов, увеличение размера ответов
**Влияние:** Улучшает опыт разработчиков при интеграции с API за счет стандартизированного формата ошибок, упрощает диагностику проблем через трассировку запросов.

## Links
- NFR-06 (Единый формат ошибок)
- R3, F5, F11 из Thread Model
