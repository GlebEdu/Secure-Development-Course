# ADR-002: Единый формат ошибок по RFC 7807
Дата: 2025-10-20
Статус: Accepted

## Context
Текущий формат ошибок `{"error": {"code": ..., "message": ...}}` нестандартен. RFC 7807 предоставляет общепринятый стандарт для machine-readable ошибок, улучшая клиентский опыт и совместимость.

## Decision
Принять RFC 7807 с расширениями для внутренней совместимости:

```json
{
  "type": "https://habittracker.com/errors/validation-error",
  "title": "Validation Failed",
  "status": 400,
  "detail": "Name must be between 1 and 100 characters",
  "instance": "/habits",
  "code": "VALIDATION_ERROR",
  "timestamp": "2025-09-22T10:30:00Z",
  "correlation_id": "req-123456"
}
```

**Технические детали реализации:**
*   **Базовый класс:** `ApiError` в `errorsRFC7807.py` для бизнес-ошибок приложения
*   **Формирование ответов:** Функция `create_problem_response()` с генерацией `correlation_id` и временных меток
*   **Глобальные обработчики:** Зарегистрированы для `ApiError`, `HTTPException` и общего `Exception`

## Альтернативные решения

### Вариант 1: Сохранение текущего кастомного формата
**Плюсы:**
- Уже реализован и работает
- Компактный размер ответов
- Не требует миграции существующих клиентов

**Минусы:**
- Нестандартный подход, усложняет интеграцию с внешними клиентами
- Ограниченные возможности для расширения
- Нет стандартных полей для трассировки (correlation_id, timestamp)
- Может потребовать доработки при добавлении новых типов ошибок

### Вариант 2: RFC 7807 (ВЫБРАНО)
**Плюсы:**
- Общепринятый стандарт, знакомый разработчикам
- Расширяемая структура с предсказуемыми полями
- Встроенная поддержка трассировки и временных меток
- Лучшая документация и инструменты экосистемы

**Минусы:**
- Больший размер ответов
- Необходимость миграции существующих клиентов
- Дополнительная сложность в реализации

## Consequences
### Security Impact
*   **Положительные:** Стандартизированный формат уменьшает риск утечки чувствительной информации через stack traces. `correlation_id` позволяет безопасно делиться информацией об ошибках со службой поддержки без раскрытия внутренних деталей. Контролируемое раскрытие информации через предопределенные поля.
*   **Отрицательные/Риски:** Неправильная конфигурация может привести к излишнему раскрытию информации в деталях ошибок. *Мера смягчения: в продакшене детали внутренних ошибок (500+) должны быть обобщены.*

### Overall Impact
*   **KPI/SLO:** Улучшается наблюдаемость системы - можно отслеживать частоту ошибок по типам через `correlation_id`, снижается MTTR (Mean Time To Resolution) за счет лучшей трассировки.
*   **Разработка:** Упрощается разработка клиентов - единый формат обработки ошибок для всех сценариев
*   **Производительность:** Незначительное увеличение размера передаваемых данных

## Rollout Plan
[**C4: План внедрения в вашем проекте ★★2**]
*   **Definition of Done (DoD):**
    1.  Все классы ошибок и обработчики реализованы в `errorsRFC7807.py`
    2.  Глобальные обработчики зарегистрированы в `main.py`
    3.  Написаны тесты, проверяющие RFC 7807 формат ошибок

*   **План внедрения:**
    1.  Реализовать `ApiError` класс и обработчики в `errorsRFC7807.py`
    2.  Зарегистрировать обработчики в приложении FastAPI
    3.  Обновить существующие эндпоинты для использования `ApiError`
    4.  Написать тесты

## Links
- NFR-06 (Единый формат ошибок)
- R3, F5, F11 из Thread Model
- Тесты в test_habits.py, test_health.py
